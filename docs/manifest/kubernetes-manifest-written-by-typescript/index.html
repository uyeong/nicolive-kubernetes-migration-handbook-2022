<!doctype html><html lang=kr-kr dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="쿠버네티스의 매니페스트를 타입스크립트로 작성하는 방법을 다룬다. OpenAPI 스키마로 부터 자동 생성된 타입 정의를 사용하며 타입스크립트와 npm 라이브러리의 에코시스템을 활용한다."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="타입스크립트로 쿠버네티스의 매니페스트를 작성한다"><meta property="og:description" content="쿠버네티스의 매니페스트를 타입스크립트로 작성하는 방법을 다룬다. OpenAPI 스키마로 부터 자동 생성된 타입 정의를 사용하며 타입스크립트와 npm 라이브러리의 에코시스템을 활용한다."><meta property="og:type" content="article"><meta property="og:url" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-written-by-typescript/"><meta property="og:image" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-07-18T16:35:46+09:00"><title>타입스크립트로 쿠버네티스의 매니페스트를 작성한다 | 니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</title><link rel=manifest href=/nicolive-kubernetes-migration-handbook-2022/manifest.json><link rel=icon href=/nicolive-kubernetes-migration-handbook-2022/favicon.png type=image/x-icon><link rel=stylesheet href=/nicolive-kubernetes-migration-handbook-2022/book.min.fcc3ce6727c2b2b91bc9a518374b77e2097222f7fe4dc0016db675da315da284.css integrity="sha256-/MPOZyfCsrkbyaUYN0t34glyIvf+TcABbbZ12jFdooQ=" crossorigin=anonymous><script defer src=/nicolive-kubernetes-migration-handbook-2022/sw.min.dd2d6bf3c93d9223651db8ea5867f95fed658724b711f7b9e9e1d8aa46a84ebd.js integrity="sha256-3S1r88k9kiNlHbjqWGf5X+1lhyS3Efe56eHYqkaoTr0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta name=twitter:title content="타입스크립트로 쿠버네티스의 매니페스트를 작성한다"><meta name=twitter:description content="쿠버네티스의 매니페스트를 타입스크립트로 작성하는 방법을 다룬다. OpenAPI 스키마로 부터 자동 생성된 타입 정의를 사용하며 타입스크립트와 npm 라이브러리의 에코시스템을 활용한다."></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/nicolive-kubernetes-migration-handbook-2022/><span>니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</span></a></h2><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/about/>이 핸드북에 대해</a><ul></ul></li><li><span>네트워크</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/network/architecture/>이전 전 / 중 / 후의 네트워크 설계</a></li></ul></li><li><span>매니페스트 관리</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/manifest-management/>쿠버네티스의 매니페스트 관리</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-written-by-typescript/ class=active>타입스크립트로 쿠버네티스의 매니페스트를 작성한다</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-generator-architecture/>TypeScriptでManifestを生成するGeneratorのアーキテクチャ</a></li></ul></li><li><span>Continuous Delivery</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-cd/>Argo CDの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-rollouts/>Argo Rolloutsの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/slack-bot/>Slack Botによる自動化</a></li></ul></li><li><span>Service Mesh (Istio)</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/istio/>BFFとIstio</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/access-log/>アクセスログ</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/traffic-management/>Istio Ingress Gatewayの設定</a></li></ul></li><li><span>Rate Limit</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/global-ratelimit/>Global RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/local-ratelimit/>Local RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/ratelimit-is-unless/>RateLimitで負荷の上昇を防げないパターン</a></li></ul></li><li><span>スケーリング</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/scalability/horizontal-pod-autoscaler/>水平スケール</a></li></ul></li><li><span>負荷</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-test/>負荷試験</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/monitoring/>モニタリング</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-balancing/>負荷分散</a></li></ul></li><li><span>Docker SwarmからKubernetesへの移行</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/migrate-docker-swarm-to-kubernetes/>通信経路の切り替え</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/application/>アプリケーションの移行</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/menu.svg class=book-icon alt=Menu></label>
<strong>타입스크립트로 쿠버네티스의 매니페스트를 작성한다</strong>
<label for=toc-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#기본적인-작성-방법>기본적인 작성 방법</a></li><li><a href=#타입스크립트로-작성할-때의-특징>타입스크립트로 작성할 때의 특징</a><ul><li><a href=#자유로운-yaml-작성법>자유로운 YAML 작성법</a></li><li><a href=#주석을-활용한-효율적인-문서화>주석을 활용한 효율적인 문서화</a></li><li><a href=#변수를-이용한-관계성-표현>변수를 이용한 관계성 표현</a></li><li><a href=#템플릿의-표현력-증가>템플릿의 표현력 증가</a></li><li><a href=#테스트-역할을-대신하는-제너레이터>테스트 역할을 대신하는 제너레이터</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=타입스크립트로-쿠버네티스의-매니페스트를-작성한다>타입스크립트로 쿠버네티스의 매니페스트를 작성한다
<a class=anchor href=#%ed%83%80%ec%9e%85%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%8a%b8%eb%a1%9c-%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4%ec%9d%98-%eb%a7%a4%eb%8b%88%ed%8e%98%ec%8a%a4%ed%8a%b8%eb%a5%bc-%ec%9e%91%ec%84%b1%ed%95%9c%eb%8b%a4>#</a></h1><p>이번 절에서는 기본적인 작성 방법을 소개한다.</p><h2 id=기본적인-작성-방법>기본적인 작성 방법
<a class=anchor href=#%ea%b8%b0%eb%b3%b8%ec%a0%81%ec%9d%b8-%ec%9e%91%ec%84%b1-%eb%b0%a9%eb%b2%95>#</a></h2><p>아래 코드는 타입스크립트로 작성한 스크립트(노드에서 동작하는)의 예다. 이를 <code>ts-node</code> 등으로 실행하면 <code>deployment.yml</code>가 출력되며 <code>kubectl apply -f deployment.yml</code>하여 쿠버네티스 상에 팟을 기동 시킬 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;fs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>yaml</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;js-yaml&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>Schemas</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@himenon/kubernetes-typescript-openapi/v1.22.3&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>podTemplateSpec</span>: <span style=color:#66d9ef>Schemas.io$k8s$api$core$v1$PodTemplateSpec</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>containers</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>image</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx:1.14.2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>80</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deployment</span>: <span style=color:#66d9ef>Schemas.io$k8s$api$apps$v1$Deployment</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;apps/v1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Deployment&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx-deployment&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>replicas</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>matchLabels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>template</span>: <span style=color:#66d9ef>podTemplateSpec</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>dump</span>(<span style=color:#a6e22e>deployment</span>, { <span style=color:#a6e22e>noRefs</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>lineWidth</span>: <span style=color:#66d9ef>144</span> });
</span></span><span style=display:flex><span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFileSync</span>(<span style=color:#e6db74>&#34;deployment.yml&#34;</span>, <span style=color:#a6e22e>text</span>, <span style=color:#e6db74>&#34;utf-8&#34;</span>);
</span></span></code></pre></div><h2 id=타입스크립트로-작성할-때의-특징>타입스크립트로 작성할 때의 특징
<a class=anchor href=#%ed%83%80%ec%9e%85%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%8a%b8%eb%a1%9c-%ec%9e%91%ec%84%b1%ed%95%a0-%eb%95%8c%ec%9d%98-%ed%8a%b9%ec%a7%95>#</a></h2><p>타입스크립트로 작성할 때의 특정을 소개한다.</p><h3 id=자유로운-yaml-작성법>자유로운 YAML 작성법
<a class=anchor href=#%ec%9e%90%ec%9c%a0%eb%a1%9c%ec%9a%b4-yaml-%ec%9e%91%ec%84%b1%eb%b2%95>#</a></h3><p>우선 가장 느끼기 쉬운 특징으로는 YAML의 작성 방법에 껄끄러움이 없다는 것이다.
YAML은 단순한 출력 결과이며 출력하는 처리가 기법을 규격화하기 때문에 YAML의 작성 기법에 대한 리뷰가 필요 없다.</p><ol><li>들여쓰기는 공백인지 탭인지 여부</li><li>들여쓰기는 공백 2칸인지 4칸인지 여부</li><li>여러 행 주석은 <code>|</code>, <code>></code> 중 어느 것으로 할 것인지 여부</li><li>알파벳 순으로 정렬할 것인지 여부</li></ol><p>등, 위와 같은 사항을 생각할 필요 없다.</p><h3 id=주석을-활용한-효율적인-문서화>주석을 활용한 효율적인 문서화
<a class=anchor href=#%ec%a3%bc%ec%84%9d%ec%9d%84-%ed%99%9c%ec%9a%a9%ed%95%9c-%ed%9a%a8%ec%9c%a8%ec%a0%81%ec%9d%b8-%eb%ac%b8%ec%84%9c%ed%99%94>#</a></h3><p>타입스크립트의 코드 주석을 그대로 이용할 수 있다.
따라서 변수명에 마우스 커서를 올렸을 때 주석이 함께 보이는 등의 에디터의 편의 기능을 지원 받을 수 있다.</p><p>또, 주석은 그대로 문서의 의미 갖게 되므로 매니페스트와 문서의 괴리를 예방해 혼란스러움을 막을 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>/** podTemplate 관련 주석 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>podTemplateSpec</span>: <span style=color:#66d9ef>Schemas.io$k8s$api$core$v1$PodTemplateSpec</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deployment</span>: <span style=color:#66d9ef>Schemas.io$k8s$api$apps$v1$Deployment</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;apps/v1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Deployment&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx-deployment&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>/** 이 라벨을 붙인 이유 작성 */</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 레플리카를 3으로 설정한 이유 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>replicas</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 이 셀렉터를 붙인 이유 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>matchLabels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>template</span>: <span style=color:#66d9ef>podTemplateSpec</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=변수를-이용한-관계성-표현>변수를 이용한 관계성 표현
<a class=anchor href=#%eb%b3%80%ec%88%98%eb%a5%bc-%ec%9d%b4%ec%9a%a9%ed%95%9c-%ea%b4%80%ea%b3%84%ec%84%b1-%ed%91%9c%ed%98%84>#</a></h3><p>쿠버네티스에서 기본적인 서비스와 디플로이먼트라는 세트를 떠올려보자. 서비스간 통신을 위해서는 서비스의 셀렉터를 팟의 라벨과 일치시켜야 한다. 이 셀렉터와 라벨 부분을 타입스크립트의 변수로 지정하면 확실하게 관계를 드러내어 서비스와 디플로이먼트 매니페스트를 생성할 수 있다.</p><p>이 외에도 <a href=https://kubernetes.io/ja/docs/concepts/overview/working-with-objects/common-labels/>권장되는 라벨</a>인 <code>app.kubernetes.io/version</code> 등도 누락없이 적절하게 지정할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Namespace</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mynamespace&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateService</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>applicationName</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>applicationVersion</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Schemas</span>.<span style=color:#a6e22e>io$k8s$api$core$v1$Service</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Service&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>applicationName</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>namespace</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Namespace</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ClusterIP&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app</span>: <span style=color:#66d9ef>applicationName</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;app.kubernetes.io/name&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>applicationName</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`http-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>applicationName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-svc`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>80</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>targetPort</span>: <span style=color:#66d9ef>80</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateDeployment</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>applicationName</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>applicationVersion</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Schemas</span>.<span style=color:#a6e22e>io$k8s$api$apps$v1$Deployment</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;apps/v1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Deployment&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>applicationName</span>,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>namespace</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Namespace</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>labels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>app</span>: <span style=color:#66d9ef>applicationName</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;app.kubernetes.io/name&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>applicationName</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>annotations</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>matchLabels</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;app.kubernetes.io/name&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>applicationName</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#75715e>/** 생략 */</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>applicationName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-nginx&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>applicationVersion</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.14.2&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>generateService</span>(<span style=color:#a6e22e>applicationName</span>, <span style=color:#a6e22e>applicationVersion</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>generateDeployment</span>(<span style=color:#a6e22e>applicationName</span>, <span style=color:#a6e22e>applicationVersion</span>);
</span></span></code></pre></div><h3 id=템플릿의-표현력-증가>템플릿의 표현력 증가
<a class=anchor href=#%ed%85%9c%ed%94%8c%eb%a6%bf%ec%9d%98-%ed%91%9c%ed%98%84%eb%a0%a5-%ec%a6%9d%ea%b0%80>#</a></h3><p>예를 들어 노드, 고, 스칼라 등 다양한 언어로 구현된 마이크로서비스를 위한 기본적인 디플로이먼트 템플릿 등을 준비할 수 있다.
예를 들어 <code>/a</code>와 <code>/b</code>의 엔드포인트가 같은 서버에서 제공되고 있지만, 수평 확장(scale out) 단위나 CPU / MEM 등 각각의 자원을 분리하여 관리하고자 매니페스트를 분할 하고 싶을 때에 큰 도움이 된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateNodeJsDeployment</span> <span style=color:#f92672>=</span> ()<span style=color:#f92672>:</span><span style=color:#a6e22e>Schemas</span>.<span style=color:#a6e22e>io$k8s$api$apps$v1$Deployment</span> <span style=color:#f92672>=&gt;</span> {};
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateRubyOnRailsDeployment</span> <span style=color:#f92672>=</span> ()<span style=color:#f92672>:</span><span style=color:#a6e22e>Schemas</span>.<span style=color:#a6e22e>io$k8s$api$apps$v1$Deployment</span> <span style=color:#f92672>=&gt;</span> {};
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateScalaDeployment</span> <span style=color:#f92672>=</span> ()<span style=color:#f92672>:</span><span style=color:#a6e22e>Schemas</span>.<span style=color:#a6e22e>io$k8s$api$apps$v1$Deployment</span> <span style=color:#f92672>=&gt;</span> {};
</span></span></code></pre></div><h3 id=테스트-역할을-대신하는-제너레이터>테스트 역할을 대신하는 제너레이터
<a class=anchor href=#%ed%85%8c%ec%8a%a4%ed%8a%b8-%ec%97%ad%ed%95%a0%ec%9d%84-%eb%8c%80%ec%8b%a0%ed%95%98%eb%8a%94-%ec%a0%9c%eb%84%88%eb%a0%88%ec%9d%b4%ed%84%b0>#</a></h3><p>매니페스트를 생성 시에 활용할 테스트 프레임워크는 불필요하며, 단순하게 <code>Exception</code>을 발생시키는 것 만으로도 충분한 테스트가 된다.
예를 들어 <code>metadata.name</code>에 지정할 수 있는 문자열 또는 문자수는 <code>Service</code>나 <code>Job</code> 등의 리소스 타입으로 정해져 있다（<a href=https://kubernetes.io/ja/docs/concepts/overview/working-with-objects/names/#dns-label-names>참고</a>）。</p><p>큰 변경을 시도하고나서 <code>kubectl apply</code> 실행 후 문제를 발견 한 경우라면 원인을 찾는데 꽤 수고가 필요하다. 하지만 매니페스트를 생성하는 시점에 구체적인 에러 메시지를 출력하고 처리를 중단한다면 문제의 원인을 즉시 알 수 있다.
로컬 환경에서 생성해보지 않고 곧바로 PR 할 경우 CI 단계에서 생성을 시도하여 검증할 수 있다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validateMetadataName</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>text</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>throwError?</span>: <span style=color:#66d9ef>true</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>throwError</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>text</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>63</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`May not be deployed correctly because it exceeds 63 characters.</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>nValue: &#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>text</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>text</span>.<span style=color:#a6e22e>slice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>63</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateJob</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>applicationName</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Schemas</span>.<span style=color:#a6e22e>io$k8s$api$batch$v1$Job</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;batch/v1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Job&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>validateMetadataName</span>(<span style=color:#a6e22e>applicationName</span>, <span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/commit/d409ca76dbcfae9550bfaaf5b3299932ceacc123 title="Last modified by U-Yeong Ju | July 18, 2022" target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/calendar.svg class=book-icon alt=Calendar>
<span>July 18, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/edit/main/content/docs/manifest/kubernetes-manifest-written-by-typescript.md target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#기본적인-작성-방법>기본적인 작성 방법</a></li><li><a href=#타입스크립트로-작성할-때의-특징>타입스크립트로 작성할 때의 특징</a><ul><li><a href=#자유로운-yaml-작성법>자유로운 YAML 작성법</a></li><li><a href=#주석을-활용한-효율적인-문서화>주석을 활용한 효율적인 문서화</a></li><li><a href=#변수를-이용한-관계성-표현>변수를 이용한 관계성 표현</a></li><li><a href=#템플릿의-표현력-증가>템플릿의 표현력 증가</a></li><li><a href=#테스트-역할을-대신하는-제너레이터>테스트 역할을 대신하는 제너레이터</a></li></ul></li></ul></nav></div></aside></main></body></html>