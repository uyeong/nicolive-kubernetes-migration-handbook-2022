<!doctype html><html lang=kr-kr dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="BFF에서의 쿠버네티느 매니페스트 관리와 관련한 문제 정리 및 대응 방법을 간단하 소개한다."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="쿠버네티스의 매니페스트 관리"><meta property="og:description" content="BFF에서의 쿠버네티느 매니페스트 관리와 관련한 문제 정리 및 대응 방법을 간단하 소개한다."><meta property="og:type" content="article"><meta property="og:url" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/docs/manifest/manifest-management/"><meta property="og:image" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-07-15T11:51:07+09:00"><title>쿠버네티스의 매니페스트 관리 | 니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</title><link rel=manifest href=/nicolive-kubernetes-migration-handbook-2022/manifest.json><link rel=icon href=/nicolive-kubernetes-migration-handbook-2022/favicon.png type=image/x-icon><link rel=stylesheet href=/nicolive-kubernetes-migration-handbook-2022/book.min.fcc3ce6727c2b2b91bc9a518374b77e2097222f7fe4dc0016db675da315da284.css integrity="sha256-/MPOZyfCsrkbyaUYN0t34glyIvf+TcABbbZ12jFdooQ=" crossorigin=anonymous><script defer src=/nicolive-kubernetes-migration-handbook-2022/sw.min.dd2d6bf3c93d9223651db8ea5867f95fed658724b711f7b9e9e1d8aa46a84ebd.js integrity="sha256-3S1r88k9kiNlHbjqWGf5X+1lhyS3Efe56eHYqkaoTr0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta name=twitter:title content="쿠버네티스의 매니페스트 관리"><meta name=twitter:description content="BFF에서의 쿠버네티느 매니페스트 관리와 관련한 문제 정리 및 대응 방법을 간단하 소개한다."></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/nicolive-kubernetes-migration-handbook-2022/><span>니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</span></a></h2><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/about/>이 핸드북에 대해</a><ul></ul></li><li><span>네트워크</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/network/architecture/>이전 전 / 중 / 후의 네트워크 설계</a></li></ul></li><li><span>매니페스트 관리</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/manifest-management/ class=active>쿠버네티스의 매니페스트 관리</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-written-by-typescript/>TypeScriptでKubernetesのmanifestを記述する</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-generator-architecture/>TypeScriptでManifestを生成するGeneratorのアーキテクチャ</a></li></ul></li><li><span>Continuous Delivery</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-cd/>Argo CDの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-rollouts/>Argo Rolloutsの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/slack-bot/>Slack Botによる自動化</a></li></ul></li><li><span>Service Mesh (Istio)</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/istio/>BFFとIstio</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/access-log/>アクセスログ</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/traffic-management/>Istio Ingress Gatewayの設定</a></li></ul></li><li><span>Rate Limit</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/global-ratelimit/>Global RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/local-ratelimit/>Local RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/ratelimit-is-unless/>RateLimitで負荷の上昇を防げないパターン</a></li></ul></li><li><span>スケーリング</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/scalability/horizontal-pod-autoscaler/>水平スケール</a></li></ul></li><li><span>負荷</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-test/>負荷試験</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/monitoring/>モニタリング</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-balancing/>負荷分散</a></li></ul></li><li><span>Docker SwarmからKubernetesへの移行</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/migrate-docker-swarm-to-kubernetes/>通信経路の切り替え</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/application/>アプリケーションの移行</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/menu.svg class=book-icon alt=Menu></label>
<strong>쿠버네티스의 매니페스트 관리</strong>
<label for=toc-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#이전-후-각-컴포넌트의-파일-수로-살펴보는-규모>이전 후 각 컴포넌트의 파일 수로 살펴보는 규모</a></li><li><a href=#문제-의식>문제 의식</a><ul><li><a href=#타입스크립트로-매니페스트의-관리-문제를-해결>타입스크립트로 매니페스트의 관리 문제를 해결</a></li></ul></li><li><a href=#타입스크립트로-쿠버네티스를-작성하기-위한-지원-라이브러리와-스키마>타입스크립트로 쿠버네티스를 작성하기 위한 지원 라이브러리와 스키마</a></li><li><a href=#다른-라이브러리>다른 라이브러리</a></li></ul></nav></aside></header><article class=markdown><h1 id=쿠버네티스의-매니페스트-관리>쿠버네티스의 매니페스트 관리
<a class=anchor href=#%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4%ec%9d%98-%eb%a7%a4%eb%8b%88%ed%8e%98%ec%8a%a4%ed%8a%b8-%ea%b4%80%eb%a6%ac>#</a></h1><p>이번 장에서는 매니페스트 관리를 어떻게 하고 있는지 소개한다.
결론부터 말하면 우리는 쿠버네티스에서 이용할 매니페스트를 생성해 주는 제너레이터를 타입스크립트로 구축했다.</p><p>어떻게 구축하여 운용하고 있는지 설명한다.</p><h2 id=이전-후-각-컴포넌트의-파일-수로-살펴보는-규모>이전 후 각 컴포넌트의 파일 수로 살펴보는 규모
<a class=anchor href=#%ec%9d%b4%ec%a0%84-%ed%9b%84-%ea%b0%81-%ec%bb%b4%ed%8f%ac%eb%84%8c%ed%8a%b8%ec%9d%98-%ed%8c%8c%ec%9d%bc-%ec%88%98%eb%a1%9c-%ec%82%b4%ed%8e%b4%eb%b3%b4%eb%8a%94-%ea%b7%9c%eb%aa%a8>#</a></h2><p><a href=../../../#%ec%9d%b4%ec%a0%84-%ed%9b%84-%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4%ec%9d%98-%eb%8c%80%eb%9e%b5%ec%a0%81%ec%9d%b8-%ea%b7%9c%eb%aa%a8>도입</a> 부분에서 다뤘던 자료를 다시금 언급. <strong>프런트엔드와 관련한 마이크로서비스</strong>의 매니페스트는 다음과 같은 규모로 존재한다.
이는 간단히 관리할 수 없는 컴포넌트 수이며 앞으로도 늘어날 전망이다.</p><table><thead><tr><th style=text-align:left>컴포넌트</th><th style=text-align:right>파일 수</th></tr></thead><tbody><tr><td style=text-align:left>v1/Deployment</td><td style=text-align:right>20</td></tr><tr><td style=text-align:left>v1/Service</td><td style=text-align:right>60</td></tr><tr><td style=text-align:left>v1/Config Map</td><td style=text-align:right>15</td></tr><tr><td style=text-align:left>batch/v1/Job</td><td style=text-align:right>15</td></tr><tr><td style=text-align:left>argoproj.io/v1alpha1/Rollout</td><td style=text-align:right>20</td></tr><tr><td style=text-align:left>networking.istio.io/v1beta1/VirtualService</td><td style=text-align:right>20</td></tr><tr><td style=text-align:left>networking.istio.io/v1alpha3/EnvoyFilter</td><td style=text-align:right>20</td></tr></tbody></table><h2 id=문제-의식>문제 의식
<a class=anchor href=#%eb%ac%b8%ec%a0%9c-%ec%9d%98%ec%8b%9d>#</a></h2><p>이전 전 단계에서 이미 파일 수는 YAML로 관리하기에는 곤란한 양이었으며 도구를 활용한 보완이나 테스트 없이는 반드시 큰 문제를 야기할 수 있다고 쉽게 예상할 수 있다. 이러한 상황은 이전 프로젝트 처음에 정했던 두 가지의 목표에 어긋난다.</p><ul><li>디플로이를 민첩하고 간단하며 안전하게 실시 할 수 있다.</li><li>웹 프런트엔드 개발자가 갱신에 필요한 설정을 최소한으로 간단히 변경할 수 있다.</li></ul><h3 id=타입스크립트로-매니페스트의-관리-문제를-해결>타입스크립트로 매니페스트의 관리 문제를 해결
<a class=anchor href=#%ed%83%80%ec%9e%85%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%8a%b8%eb%a1%9c-%eb%a7%a4%eb%8b%88%ed%8e%98%ec%8a%a4%ed%8a%b8%ec%9d%98-%ea%b4%80%eb%a6%ac-%eb%ac%b8%ec%a0%9c%eb%a5%bc-%ed%95%b4%ea%b2%b0>#</a></h3><p>이 문제를 전반적으로 해결하는 한 가지 방법은 타입스크립트를 통해 쿠버네티스 YAML을 생성하는 것이다.
타입스크립트 자체의 장점은 이미 많은 글이 공개돼 있으므로 생략한다.</p><p>쿠버네티스를 운용하는 팀은 타입스크립트를 일상적으로 이용하고 있는 웹 프런트엔드 엔지니어들로 이뤄져 있다는 점만 참고한다. 그래서 타입스크립트로 매니페스트를 작성하는 것 자체에 대한 장벽은 매우 낮은 상태다.</p><p>또, 매니페스트 테스트도 타입스크립트로 YAML을 생성하는 단계에서 <code>Exception</code>을 발생시켜 버리면 되기 때문에 테스트 전략도 매우 단순하게 가져갈 수 있다.</p><p>만일 타입스크립트로 작성하는 것을 그만두고 싶은 경우에는 생성된 YAML로 대체하면 되기 때문에 타입스크립트 자체를 걷어내는 것도 간단하게 가능하다.</p><p>위와 같이 타입스크립트로 작성하지 않을 이유가 특별히 이전 설계 단계에서 드러나지 않았기 때문에 매니페스트를 YAML로 작성하는 것을 버리고 타입스크립트로 작성하기로 결정했다.</p><h2 id=타입스크립트로-쿠버네티스를-작성하기-위한-지원-라이브러리와-스키마>타입스크립트로 쿠버네티스를 작성하기 위한 지원 라이브러리와 스키마
<a class=anchor href=#%ed%83%80%ec%9e%85%ec%8a%a4%ed%81%ac%eb%a6%bd%ed%8a%b8%eb%a1%9c-%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4%eb%a5%bc-%ec%9e%91%ec%84%b1%ed%95%98%ea%b8%b0-%ec%9c%84%ed%95%9c-%ec%a7%80%ec%9b%90-%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac%ec%99%80-%ec%8a%a4%ed%82%a4%eb%a7%88>#</a></h2><p>쿠버네티스는 <code>CustomResourceDefinition</code>을 정의할 때 OpenAPI Schema V3로 기술한다. 이에 의해 실제 스키마가 적용 될 때에 유효성 검사가 이뤄진다.</p><p>다르게 말하면 OpenAPI의 스키마를 타입스크립트의 타입 정의에 활용할 수 있다면 유효성 검사를 타입스크립트의 정적 타입 분석으로 변환할 수 있다는 뜻이다.</p><p>다행히 필자는 OpanAPI 스키마와 타입스크립트에 대해 조금 자세히 알고있어 자화자찬 이지만 <a href=https://github.com/Himenon/openapi-typescript-code-generator>@himenon/openapi-typescript-code-generator</a>를 기반으로 쿠버네티스의 타입을 정의했다.</p><ul><li><a href=https://github.com/Himenon/kubernetes-typescript-openapi>@himenon/kubernetes-typescript-openapi</a></li><li><a href=https://github.com/Himenon/argocd-typescript-openapi>@himenon/argocd-typescript-openapi</a></li><li><a href=https://github.com/Himenon/argo-rollouts-typescript-openapi>@himenon/argo-rollouts-typescript-openapi</a></li></ul><p>물론 이 밖에 비슷한 접근법으로 타입 정의를 제공하고 있는 라이브러리도 있지만 다음과 같은 이유로 사용을 보류했다.</p><ul><li>직접 타입스크립트의 객체로 하여금 간단하게 타입을 정의하고 싶다.<ul><li>이는 라이브러리 쪽 지원이 중단돼도 스스로 수정할 수 있기 때문이다.</li></ul></li><li>ArgoCD나 ArgoRollouts, 이스티오 등 또 다른 사용자 정의 리소스를 사용할 때에도 동일 라이브러리를 편히 사용하고 싶다.</li><li>최신 버전 뿐 아니라 임의의 오래된 버전도 지원한다.</li></ul><p>위와 같은 내용을 미루어 볼 때 되도록 라이브러리는 얇게 구현돼 있는 것이 바람직하며, 타입 정의 라이브러리를 포크한 경우에도 간단하게 유지보수가 가능한 구현체가 필요했다. 이러한 조건을 충족하는 설계 컨셉은 <a href=https://github.com/Himenon/openapi-typescript-code-generator>@himenon/openapi-typescript-code-generator</a> 였다.</p><p>이와 관련한 자세한 내용은 다음 장에 이어서 설명하겠다.</p><ul><li><a href=../kubernetes-manifest-written-by-typescript/>타입스크립트로 쿠버네티스의 매니페스트를 작성한다</a></li><li><a href=../kubernetes-manifest-generator-architecture/>타입스크립트로 매니페스트를 생성하는 제너레이터 아키텍처</a></li></ul><h2 id=다른-라이브러리>다른 라이브러리
<a class=anchor href=#%eb%8b%a4%eb%a5%b8-%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac>#</a></h2><p>쿠버네티스 용 타입스크립트 라이브러리는 다음과 같다.</p><ul><li><a href=https://github.com/cdk8s-team/cdk8s>cdk8s</a></li><li><a href=https://github.com/tommy351/kosko>kosko</a></li></ul><p>쿠버네티스의 정의(definition)는 <a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>CustomResourceDefinition</a>를 참고한다.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/commit/7445659935e57466fed0bc03a3f4d9f785658ab3 title="Last modified by U-Yeong Ju | July 15, 2022" target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/calendar.svg class=book-icon alt=Calendar>
<span>July 15, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/edit/main/content/docs/manifest/manifest-management.md target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#이전-후-각-컴포넌트의-파일-수로-살펴보는-규모>이전 후 각 컴포넌트의 파일 수로 살펴보는 규모</a></li><li><a href=#문제-의식>문제 의식</a><ul><li><a href=#타입스크립트로-매니페스트의-관리-문제를-해결>타입스크립트로 매니페스트의 관리 문제를 해결</a></li></ul></li><li><a href=#타입스크립트로-쿠버네티스를-작성하기-위한-지원-라이브러리와-스키마>타입스크립트로 쿠버네티스를 작성하기 위한 지원 라이브러리와 스키마</a></li><li><a href=#다른-라이브러리>다른 라이브러리</a></li></ul></nav></div></aside></main></body></html>