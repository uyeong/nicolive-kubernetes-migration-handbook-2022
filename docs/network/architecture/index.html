<!doctype html><html lang=kr-kr dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kubernetes로 애플리케이션을 교체 하면서 변화한 네트워크 설계를 소개한다."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="이전 전 / 중 / 후의 네트워크 설계"><meta property="og:description" content="Kubernetes로 애플리케이션을 교체 하면서 변화한 네트워크 설계를 소개한다."><meta property="og:type" content="article"><meta property="og:url" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/docs/network/architecture/"><meta property="og:image" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-07-14T18:01:13+09:00"><title>이전 전 / 중 / 후의 네트워크 설계 | 니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</title><link rel=manifest href=/nicolive-kubernetes-migration-handbook-2022/manifest.json><link rel=icon href=/nicolive-kubernetes-migration-handbook-2022/favicon.png type=image/x-icon><link rel=stylesheet href=/nicolive-kubernetes-migration-handbook-2022/book.min.fcc3ce6727c2b2b91bc9a518374b77e2097222f7fe4dc0016db675da315da284.css integrity="sha256-/MPOZyfCsrkbyaUYN0t34glyIvf+TcABbbZ12jFdooQ=" crossorigin=anonymous><script defer src=/nicolive-kubernetes-migration-handbook-2022/sw.min.dd2d6bf3c93d9223651db8ea5867f95fed658724b711f7b9e9e1d8aa46a84ebd.js integrity="sha256-3S1r88k9kiNlHbjqWGf5X+1lhyS3Efe56eHYqkaoTr0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta name=twitter:title content="이전 전 / 중 / 후의 네트워크 설계"><meta name=twitter:description content="Kubernetes로 애플리케이션을 교체 하면서 변화한 네트워크 설계를 소개한다."></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/nicolive-kubernetes-migration-handbook-2022/><span>니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</span></a></h2><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/about/>이 핸드북에 대해</a><ul></ul></li><li><span>네트워크</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/network/architecture/ class=active>이전 전 / 중 / 후의 네트워크 설계</a></li></ul></li><li><span>Manifest管理</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/manifest-management/>KubernetesのManifest管理</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-written-by-typescript/>TypeScriptでKubernetesのmanifestを記述する</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-generator-architecture/>TypeScriptでManifestを生成するGeneratorのアーキテクチャ</a></li></ul></li><li><span>Continuous Delivery</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-cd/>Argo CDの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-rollouts/>Argo Rolloutsの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/slack-bot/>Slack Botによる自動化</a></li></ul></li><li><span>Service Mesh (Istio)</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/istio/>BFFとIstio</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/access-log/>アクセスログ</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/traffic-management/>Istio Ingress Gatewayの設定</a></li></ul></li><li><span>Rate Limit</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/global-ratelimit/>Global RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/local-ratelimit/>Local RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/ratelimit-is-unless/>RateLimitで負荷の上昇を防げないパターン</a></li></ul></li><li><span>スケーリング</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/scalability/horizontal-pod-autoscaler/>水平スケール</a></li></ul></li><li><span>負荷</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-test/>負荷試験</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/monitoring/>モニタリング</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-balancing/>負荷分散</a></li></ul></li><li><span>Docker SwarmからKubernetesへの移行</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/migrate-docker-swarm-to-kubernetes/>通信経路の切り替え</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/application/>アプリケーションの移行</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/menu.svg class=book-icon alt=Menu></label>
<strong>이전 전 / 중 / 후의 네트워크 설계</strong>
<label for=toc-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#이전-전의-네트워크-구성>이전 전의 네트워크 구성</a></li><li><a href=#이전-중의-네트워크-구성>이전 중의 네트워크 구성</a></li><li><a href=#이전-후의-네트워크-구성>이전 후의 네트워크 구성</a></li><li><a href=#아파치를-이전-간-로드밸런서로-선택한-이유>아파치를 이전 간 로드밸런서로 선택한 이유</a></li></ul></nav></aside></header><article class=markdown><h1 id=이전-전--중--후의-네트워크-설계>이전 전 / 중 / 후의 네트워크 설계
<a class=anchor href=#%ec%9d%b4%ec%a0%84-%ec%a0%84--%ec%a4%91--%ed%9b%84%ec%9d%98-%eb%84%a4%ed%8a%b8%ec%9b%8c%ed%81%ac-%ec%84%a4%ea%b3%84>#</a></h1><h2 id=이전-전의-네트워크-구성>이전 전의 네트워크 구성
<a class=anchor href=#%ec%9d%b4%ec%a0%84-%ec%a0%84%ec%9d%98-%eb%84%a4%ed%8a%b8%ec%9b%8c%ed%81%ac-%ea%b5%ac%ec%84%b1>#</a></h2><p><img src=../docker-swarm-network.svg alt="이전 전의 네트워크 구성"></p><p>위 그림은 이전 전 즉, 도커 스웜 위주의 네트워크 구성도다.</p><p>트래픽을 최상위의 로드밸런서에서 받은 뒤 아파치(혹은 엔진엑스, OpenResty 등)와 같은 L7 로드밸런서에 전달한 후 도커 스웜의 클러스터에 도달한다. 이어서 컨테이너 네트워크에 접속 되고 최종적으로 웹 애플리케이션이 응답을 반환하게 된다.</p><h2 id=이전-중의-네트워크-구성>이전 중의 네트워크 구성
<a class=anchor href=#%ec%9d%b4%ec%a0%84-%ec%a4%91%ec%9d%98-%eb%84%a4%ed%8a%b8%ec%9b%8c%ed%81%ac-%ea%b5%ac%ec%84%b1>#</a></h2><p><img src=../migrate-network.svg alt="이전 중의 네트워크 구성"></p><p>위 그림은 도커 스웜에서 쿠버네티스로 이전하는 과정 중 활용한 네트워크 구성이다.
기본적인 이전 방법으로 클러스터 외의 로드밸런스로 부터 신/구버전 환경을 <code>PATH</code>로 지정하고 나누어 단계적 이전을 수행한다.</p><p>여기에서 아파치를 해당 핸들러 역할로 선택한 이유는 [후술](#아파치를 이전 간 로드밸런서로 선택한 이유) 한다.</p><h2 id=이전-후의-네트워크-구성>이전 후의 네트워크 구성
<a class=anchor href=#%ec%9d%b4%ec%a0%84-%ed%9b%84%ec%9d%98-%eb%84%a4%ed%8a%b8%ec%9b%8c%ed%81%ac-%ea%b5%ac%ec%84%b1>#</a></h2><p><img src=../kubernetes-network.svg alt="이전 후의 네트워크 구성"></p><p>쿠버네티스 위주의 네트워크 구성은 위 그림과 같다.
아파치에 의한 로드밸런스는 이전 전 즉, 도커 스웜과 같지만 모든 애플리케이션은 한번은 모두 이스티오(istio)의 인그레스 게이트웨이를 경유하도록 됐다.</p><p>또, Rate Limit 등 엔진엑스로 수행하던 시스템의 방위 처리는 쿠버네티스 클러스터 전체에 대한 Global Rate Limit과 Pod 단위의 Local Rate Limit으로 기능을 분할했다. 이와 관련한 자세하 내용은 별도 장에서 소개하니 참고한다.</p><ul><li><a href=../../rate-limit/global-ratelimit>Rate Limit 관련</a></li><li><a href=../../service-mesh/traffic-management>Istio Ingress Gateway 관련</a></li><li><a href=../../service-mesh/access-log>엑세스 로그 관련</a></li></ul><h2 id=아파치를-이전-간-로드밸런서로-선택한-이유>아파치를 이전 간 로드밸런서로 선택한 이유
<a class=anchor href=#%ec%95%84%ed%8c%8c%ec%b9%98%eb%a5%bc-%ec%9d%b4%ec%a0%84-%ea%b0%84-%eb%a1%9c%eb%93%9c%eb%b0%b8%eb%9f%b0%ec%84%9c%eb%a1%9c-%ec%84%a0%ed%83%9d%ed%95%9c-%ec%9d%b4%ec%9c%a0>#</a></h2><ol><li>아파치라는 L7 로드밸런서는 요청과 응답에 관련된 복잡한 헤더 처리 등을 이미 갖고 있어 단기간에 다른 시스템으로 이전하는 것은 어려울 것으로 예상했다.</li><li>아파치 외의 Down Stream 쪽에 있는 로드밸런서는 팀 권한으로 조작할 수 없기 때문에 어떠한 설정 변경에 시간이 오래 소요 될 것으로 예상했다.</li><li>아파치가 아닌 엔진엑스나 HAProxy 등을 고려하기 이전에 직접 쿠버네티스 클라스터로 트래픽을 받았을 경우에 쿠버네티스 자체나 이스티오 인그레스 게이트웨이가 트래픽의 부하에 견딜 수 있을지 신뢰할 수 있는 부하 시험의 결과가 존재하지 않았기 때문에 구환경으로 되돌려야 할 가능성도 높다고 판단했다.</li></ol><p>즉, 운용 실적과 오퍼레이션의 용이성을 미루어 볼 때 아파치로 이전하는 것이 이전 간 취할 수 있는 선택 사항으로 부터 자유롭다고 판단했다.</p><p>※ 결과는 말 할 것도 없이 작성한 대로 예상한 일정대로 이전을 완료하고 있다.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/commit/c9f9c18ad5f56af1b6a297e0472dc0aa7c015520 title="Last modified by U-Yeong Ju | July 14, 2022" target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/calendar.svg class=book-icon alt=Calendar>
<span>July 14, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/edit/main/content/docs/network/architecture.md target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#이전-전의-네트워크-구성>이전 전의 네트워크 구성</a></li><li><a href=#이전-중의-네트워크-구성>이전 중의 네트워크 구성</a></li><li><a href=#이전-후의-네트워크-구성>이전 후의 네트워크 구성</a></li><li><a href=#아파치를-이전-간-로드밸런서로-선택한-이유>아파치를 이전 간 로드밸런서로 선택한 이유</a></li></ul></nav></div></aside></main></body></html>