<!doctype html><html lang=kr-kr dir=ltr><head><meta name=generator content="Hugo 0.99.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="니코니코 생방송 웹 프런트엔드의 쿠버네티스 마이그레이션 핸드북 2022 #  시작하며 #  2021년 6월 부터 2022년 3월, 9개월 간 니코니코 생방송의 프런트엔드와 관련된 마이크로서비스를 도커 스웜에서 쿠버네티스로 이전했다. 그리고 이번 기회에 이전 전 부터 이전 중, 이전 후 전체에 걸친 설계나 운영 방법을 실제 적용한 사례를 토대로 정리해 소개 하고자 한다.
배경 #  본론으로 들어가기 전에 니코니코 생방송 웹 프런트엔드 팀이 관리하고 있던 &ldquo;개발부터 릴리스, 운용&#34;까지의 과거(이전 전의) 인프라를 가볍게 소개한다."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="니코니코 생방송 웹 프런트엔드의 쿠버네티스 마이그레이션 핸드북 2022"><meta property="og:description" content="니코니코 생방송 on Kubernetes"><meta property="og:type" content="website"><meta property="og:url" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/"><meta property="og:image" content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><title>니코니코 생방송 웹 프런트엔드의 쿠버네티스 마이그레이션 핸드북 2022 | 니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</title><link rel=manifest href=/nicolive-kubernetes-migration-handbook-2022/manifest.json><link rel=icon href=/nicolive-kubernetes-migration-handbook-2022/favicon.png type=image/x-icon><link rel=stylesheet href=/nicolive-kubernetes-migration-handbook-2022/book.min.fcc3ce6727c2b2b91bc9a518374b77e2097222f7fe4dc0016db675da315da284.css integrity="sha256-/MPOZyfCsrkbyaUYN0t34glyIvf+TcABbbZ12jFdooQ=" crossorigin=anonymous><script defer src=/nicolive-kubernetes-migration-handbook-2022/sw.min.dd2d6bf3c93d9223651db8ea5867f95fed658724b711f7b9e9e1d8aa46a84ebd.js integrity="sha256-3S1r88k9kiNlHbjqWGf5X+1lhyS3Efe56eHYqkaoTr0=" crossorigin=anonymous></script>
<link rel=alternate type=application/rss+xml href=https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/index.xml title="니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://uyeong.github.io/nicolive-kubernetes-migration-handbook-2022/site-feature-image.png"><meta name=twitter:title content="니코니코 생방송 웹 프런트엔드의 쿠버네티스 마이그레이션 핸드북 2022"><meta name=twitter:description content="니코니코 생방송 on Kubernetes"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/nicolive-kubernetes-migration-handbook-2022/><span>니코니코 생방송 웹 프런트엔드의 쿠버네티스 이전 핸드북 2022</span></a></h2><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/about/>このHandbookについて</a><ul></ul></li><li><span>ネットワーク</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/network/architecture/>移行前・移行中・移行後のネットワーク設計</a></li></ul></li><li><span>Manifest管理</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/manifest-management/>KubernetesのManifest管理</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-written-by-typescript/>TypeScriptでKubernetesのmanifestを記述する</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/manifest/kubernetes-manifest-generator-architecture/>TypeScriptでManifestを生成するGeneratorのアーキテクチャ</a></li></ul></li><li><span>Continuous Delivery</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-cd/>Argo CDの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/argo-rollouts/>Argo Rolloutsの利用</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/ci/slack-bot/>Slack Botによる自動化</a></li></ul></li><li><span>Service Mesh (Istio)</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/istio/>BFFとIstio</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/access-log/>アクセスログ</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/service-mesh/traffic-management/>Istio Ingress Gatewayの設定</a></li></ul></li><li><span>Rate Limit</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/global-ratelimit/>Global RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/local-ratelimit/>Local RateLimit</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/rate-limit/ratelimit-is-unless/>RateLimitで負荷の上昇を防げないパターン</a></li></ul></li><li><span>スケーリング</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/scalability/horizontal-pod-autoscaler/>水平スケール</a></li></ul></li><li><span>負荷</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-test/>負荷試験</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/monitoring/>モニタリング</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/performance/load-balancing/>負荷分散</a></li></ul></li><li><span>Docker SwarmからKubernetesへの移行</span><ul><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/migrate-docker-swarm-to-kubernetes/>通信経路の切り替え</a></li><li><a href=/nicolive-kubernetes-migration-handbook-2022/docs/migrate-practice/application/>アプリケーションの移行</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/menu.svg class=book-icon alt=Menu></label>
<strong>니코니코 생방송 웹 프런트엔드의 쿠버네티스 마이그레이션 핸드북 2022</strong>
<label for=toc-control><img src=/nicolive-kubernetes-migration-handbook-2022/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#시작하며>시작하며</a></li><li><a href=#배경>배경</a><ul><li><a href=#이전에-주로-활동한-사람들>이전에 주로 활동한 사람들</a></li><li><a href=#이전-후의-쿠버네티스-대략적인-규모>이전 후의 쿠버네티스 대략적인 규모</a></li></ul></li><li><a href=#읽는-방법>읽는 방법</a></li></ul></nav></aside></header><article class=markdown><h1 id=니코니코-생방송-웹-프런트엔드의-쿠버네티스-마이그레이션-핸드북-2022>니코니코 생방송 웹 프런트엔드의 쿠버네티스 마이그레이션 핸드북 2022
<a class=anchor href=#%eb%8b%88%ec%bd%94%eb%8b%88%ec%bd%94-%ec%83%9d%eb%b0%a9%ec%86%a1-%ec%9b%b9-%ed%94%84%eb%9f%b0%ed%8a%b8%ec%97%94%eb%93%9c%ec%9d%98-%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4-%eb%a7%88%ec%9d%b4%ea%b7%b8%eb%a0%88%ec%9d%b4%ec%85%98-%ed%95%b8%eb%93%9c%eb%b6%81-2022>#</a></h1><h2 id=시작하며>시작하며
<a class=anchor href=#%ec%8b%9c%ec%9e%91%ed%95%98%eb%a9%b0>#</a></h2><p>2021년 6월 부터 2022년 3월, 9개월 간 니코니코 생방송의 프런트엔드와 관련된 마이크로서비스를 도커 스웜에서 쿠버네티스로 이전했다. 그리고 이번 기회에 이전 전 부터 이전 중, 이전 후 전체에 걸친 설계나 운영 방법을 실제 적용한 사례를 토대로 정리해 소개 하고자 한다.</p><h2 id=배경>배경
<a class=anchor href=#%eb%b0%b0%ea%b2%bd>#</a></h2><p>본론으로 들어가기 전에 니코니코 생방송 웹 프런트엔드 팀이 관리하고 있던 &ldquo;개발부터 릴리스, 운용"까지의 과거(이전 전의) 인프라를 가볍게 소개한다.</p><ul><li>JS나 CSS의 정적 리소스 빌드</li><li>익스프레스(express.js) 기반의 웹 애플리케이션 서버 개발(Backend for Frontend)</li><li>도커 이미지 빌드</li><li>정적 리소스 디플로이</li><li>아파치나 엔진엑스, OpenResty와 같은 L7 로드밸런싱에 의한 트래픽 매니지먼트</li><li>젠킨스를 이용한 도커 스웜 클러스터 기반 Blue / Green 디플로이</li><li>로그 기록 및 송신</li><li>감시(DataDog 등)</li></ul><h3 id=이전에-주로-활동한-사람들>이전에 주로 활동한 사람들
<a class=anchor href=#%ec%9d%b4%ec%a0%84%ec%97%90-%ec%a3%bc%eb%a1%9c-%ed%99%9c%eb%8f%99%ed%95%9c-%ec%82%ac%eb%9e%8c%eb%93%a4>#</a></h3><p>웹 프런트엔드 팀의 두 명 정도가 주로 이전 작업을 진행했다. 다른 마이크로서비스는 별도의 팀이 담당했으며 서로 지식과 리소스 사용 현황 등을 공유 하면서 작업을 실시했다. 배경에서 언급한 인프라의 역사적 경위나 이전 후에도 유지 돼야 하는 상태를 정리하면서 쿠버네티스로 빠르게 이전하기 위한 방법을 설계하고 실현해 나갔다.</p><h3 id=이전-후의-쿠버네티스-대략적인-규모>이전 후의 쿠버네티스 대략적인 규모
<a class=anchor href=#%ec%9d%b4%ec%a0%84-%ed%9b%84%ec%9d%98-%ec%bf%a0%eb%b2%84%eb%84%a4%ed%8b%b0%ec%8a%a4-%eb%8c%80%eb%9e%b5%ec%a0%81%ec%9d%b8-%ea%b7%9c%eb%aa%a8>#</a></h3><p>쿠버네티스 상에서 동작하는 <strong>니코니코 생방송 프런트엔드와 관련된 마이크로서비스</strong>의 매니페스트 수는 (한 개의 클러스터 당) 다음과 같은 규모의 컴포넌트로 이뤄져 있다.</p><table><thead><tr><th style=text-align:left>Component</th><th style=text-align:right>파일 수</th></tr></thead><tbody><tr><td style=text-align:left>v1/Deployment</td><td style=text-align:right>22</td></tr><tr><td style=text-align:left>v1/Service</td><td style=text-align:right>60</td></tr><tr><td style=text-align:left>v1/Config Map</td><td style=text-align:right>15</td></tr><tr><td style=text-align:left>batch/v1/Job</td><td style=text-align:right>14</td></tr><tr><td style=text-align:left>argoproj.io/v1alpha1/Rollout</td><td style=text-align:right>18</td></tr><tr><td style=text-align:left>networking.istio.io/v1beta1/VirtualService</td><td style=text-align:right>20</td></tr><tr><td style=text-align:left>networking.istio.io/v1alpha3/EnvoyFilter</td><td style=text-align:right>20</td></tr></tbody></table><p>※ 대략적인 규모와 구체적인 용도를 알기 쉽도록 컴포넌트를 나열했다.</p><p><img src=./all-view.png alt="이전 기간 중의 각종 지표"></p><h2 id=읽는-방법>읽는 방법
<a class=anchor href=#%ec%9d%bd%eb%8a%94-%eb%b0%a9%eb%b2%95>#</a></h2><p>BFF 서버를 관리하는 웹 프런트엔드의 개발자 관점을 바탕으로 쿠버네티스 상에 애플리케이션을 운영하기 위한 사례를 정리 했다. 기본적으로는 스테이트리스한 애플리케이션이며, 비기능 요건에 해당하는 부분이 이 글에서 주로 다루는 주제다. 주의할 점으로 백지 상태에서 구축한 게 아닌 전신이 되는 아키텍처 구성을 토대로 한 사례 이므로 자신 있게 베스트라고 할 수 없는 구성도 존재한다.</p><p>웹 프런트엔드 개발을 하고 있는 독자는 비기능 요건에 해당하는 부분의 운용이나 비용, 감각 등을 느껴보면서 이러한 비용을 낮추기 위해 애플리케이션 수준에서는 무엇을 할 수 있을지 생각하면 인프라를 구성할 때 도움이 될 것이다. 반대로 평소 인프라를 다루고 있는 독자라면 웹 프런트엔드의 인프라를 관리할 때에 고려해야 하는 것을 중점으로 살펴보면 참고가 될 것이다.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/commit/e2ce2981f7411982df814e219b405cc3956fb4cd title="Last modified by U-Yeong Ju | July 14, 2022" target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/calendar.svg class=book-icon alt=Calendar>
<span>July 14, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/uyeong/nicolive-kubernetes-migration-handbook-2022/edit/main/content/_index.md target=_blank rel=noopener><img src=/nicolive-kubernetes-migration-handbook-2022/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#시작하며>시작하며</a></li><li><a href=#배경>배경</a><ul><li><a href=#이전에-주로-활동한-사람들>이전에 주로 활동한 사람들</a></li><li><a href=#이전-후의-쿠버네티스-대략적인-규모>이전 후의 쿠버네티스 대략적인 규모</a></li></ul></li><li><a href=#읽는-방법>읽는 방법</a></li></ul></nav></div></aside></main></body></html>